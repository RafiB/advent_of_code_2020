import attr

@attr.s(frozen=True)
class Coord(object):
    x = attr.ib()
    y = attr.ib() 


@attr.s(frozen=True)
class Tile(object):
    tile_id = attr.ib()
    tile = attr.ib()


TEST_INPUT = """Tile 2311:
..##.#..#.
##..#.....
#...##..#.
####.#...#
##.##.###.
##...#.###
.#.#.#..##
..#....#..
###...#.#.
..###..###

Tile 1951:
#.##...##.
#.####...#
.....#..##
#...######
.##.#....#
.###.#####
###.##.##.
.###....#.
..#.#..#.#
#...##.#..

Tile 1171:
####...##.
#..##.#..#
##.#..#.#.
.###.####.
..###.####
.##....##.
.#...####.
#.##.####.
####..#...
.....##...

Tile 1427:
###.##.#..
.#..#.##..
.#.##.#..#
#.#.#.##.#
....#...##
...##..##.
...#.#####
.#.####.#.
..#..###.#
..##.#..#.

Tile 1489:
##.#.#....
..##...#..
.##..##...
..#...#...
#####...#.
#..#.#.#.#
...#.#.#..
##.#...##.
..##.##.##
###.##.#..

Tile 2473:
#....####.
#..#.##...
#.##..#...
######.#.#
.#...#.#.#
.#########
.###.#..#.
########.#
##...##.#.
..###.#.#.

Tile 2971:
..#.#....#
#...###...
#.#.###...
##.##..#..
.#####..##
.#..####.#
#..#.#..#.
..####.###
..#.#.###.
...#.#.#.#

Tile 2729:
...#.#.#.#
####.#....
..#.#.....
....#..#.#
.##..##.#.
.#.####...
####.#.#..
##.####...
##..#.##..
#.##...##.

Tile 3079:
#.#.#####.
.#..######
..#.......
######....
####.#..#.
.#...#.##.
#.#####.##
..#.###...
..#.......
..#.###..."""

PUZZLE_INPUT = """Tile 2381:
#.#.#####.
#.......#.
.#.......#
#.......#.
......#..#
...#......
........##
...#..#..#
..........
..#....#.#

Tile 1303:
####...##.
#....#.#..
.##.##....
.......#.#
.#..#...##
#.......#.
...#....##
#......#.#
.........#
..#.#.#.##

Tile 3821:
.###....##
..#..#..##
.#..#.##.#
##.#.#.##.
......#...
....#.....
...#.##..#
....##..#.
#.....#..#
.##.##.###

Tile 1229:
..###.....
.#........
#.........
##..#.....
#...#.....
#..#.....#
..#.#..#.#
#.#.......
.#...#####
###.#.#..#

Tile 1787:
...#####.#
#.........
#...#..#..
.....#.#.#
##.#.....#
#.........
#..#......
##........
#...#....#
.#..##.##.

Tile 3943:
#.#.#.##.#
.#...#..##
......#...
#.....#...
....#....#
.......#..
#.......##
..........
#...#.....
#......#.#

Tile 3203:
.##..#.#.#
..#.....##
..........
##......##
#....#.#..
#......##.
..........
.........#
.#....#...
#...#.###.

Tile 2213:
##...###..
.##......#
###..#....
#.#.....#.
....##...#
....#....#
#..#.##...
...#..#...
..#.......
....##.##.

Tile 1033:
..#.###.#.
#.#...####
#.##......
##.......#
..#.......
..#.#.#..#
#..#.....#
.#........
#.........
....##..#.

Tile 2383:
#####...#.
#.....#..#
..........
#..##.....
#.....#...
##.#.#....
.....##..#
#.....#.##
#.........
.#.#.#.#..

Tile 1117:
#.##.###.#
.#....#..#
##......##
.##....##.
.#.#.#.#..
........#.
#...#.....
###.#.....
#......##.
..###..#..

Tile 3209:
...#.#..#.
###.#..#..
#.#......#
#..#...#..
#.....####
.....##.##
##...#.###
.#....####
#..#####..
..#...###.

Tile 2503:
...####.##
#........#
#.#.#....#
.........#
.#....#..#
.........#
...#......
...#....#.
##.......#
#.#...####

Tile 1579:
#.#.#..###
.#.#.##...
....#....#
#....#...#
.###..#.##
#........#
##...#...#
.......#..
#..###.#..
..#......#

Tile 2741:
######....
......#..#
..###.....
.....##...
.#.#.....#
.##...#..#
#........#
...#.#..##
.#....#...
.....#.#.#

Tile 3593:
##.##.#.#.
..#.....##
#..###....
#...#....#
#.#.####.#
.........#
#........#
#......###
.#.#.##.#.
#.###....#

Tile 2467:
.#.#.###..
##....#..#
..##..#..#
..####...#
#...##.#..
##..#..###
.........#
#..#.....#
#......##.
.####...##

Tile 1721:
##.##....#
.#.......#
#..##.#..#
......#...
..#.......
###......#
...#.....#
.........#
##..#.....
..#.#.#...

Tile 2221:
...#.#.#.#
..#.......
#.........
#..#.....#
......#.#.
#.#....#.#
......#..#
.#.......#
###.##.##.
####..#..#

Tile 2083:
..#.#.#.##
..#.....##
#..##.#.##
##........
..##.....#
..........
..#.....#.
....#..#..
.#......##
#.#...#...

Tile 3907:
#..######.
#......#.#
...#...#..
##.......#
###..#..#.
##........
#........#
.....##...
..........
###.#.#...

Tile 3067:
##.#...###
...#......
..#.#..#.#
###.#...#.
..##...#..
#...#.##..
..#....#..
#.##.....#
..#.....##
##.###..#.

Tile 2347:
####....#.
..##..#...
#........#
#.#....#.#
.#..#..###
..#..#...#
.#....##.#
#........#
.#...##..#
####...#..

Tile 2251:
#.#.##....
#...#.#..#
..#.##...#
##...##.##
##.....#.#
#.......##
.#.......#
#...#....#
#....#...#
....######

Tile 1019:
...#.#....
##.....#..
#.....#..#
#..#.....#
##....#...
...#......
..........
###...#..#
#...#.#..#
.#..#.##.#

Tile 2309:
#.#.##.#..
.....#....
#.........
#........#
.#........
....###...
#.....#..#
..#.#.#...
#..#.#..##
.....###..

Tile 1129:
.##.#.##.#
......#.#.
##.......#
.....##...
.#...#.#..
#......#..
#....#....
#...#....#
.##..##..#
###..##..#

Tile 3793:
...#.#..#.
#..#...#.#
......#...
#....##...
#....##...
....##....
##.#...##.
.........#
.........#
##...##.##

Tile 2851:
###.##....
#........#
#.#.#.#...
##..#....#
#...#...##
..#.#....#
##........
.....#.#..
#....#...#
.#.##.####

Tile 3061:
###..#.##.
...#.....#
...#......
#....#..##
#........#
##.##.....
#..#.....#
#....#..##
#..#..##.#
..####.#.#

Tile 1999:
...#...###
..........
#...####..
...#......
.#.......#
.........#
.###.....#
.##....###
#..##.#.#.
##....#...

Tile 1237:
#...#..#..
.#...#...#
#.........
.........#
...#.....#
#..#......
...#......
..##.#....
...#.....#
..#..#.#.#

Tile 3889:
.#..###.#.
.#..#....#
..#......#
#.......#.
..#.....##
#........#
#.#.#.....
#......#..
..###...#.
#....#....

Tile 3833:
###.#.#...
..#.......
##.......#
.#..#.###.
......##.#
#..##.#..#
.#.#.#.#.#
#..#....#.
##.....#..
#####..#.#

Tile 2957:
.##..##.#.
###.......
#.......##
#......#..
.......#.#
#...#...#.
##....#..#
##.....#.#
...#....##
..#.....##

Tile 1087:
#...##.#..
#...#.#..#
..........
#.....#.#.
#.#.#.....
#....##.##
##.......#
.#...#....
....#....#
###..#...#

Tile 2549:
...##..#.#
#.#####...
#..#.#...#
.##.#..#.#
..#.#....#
...#.#....
..##...#..
#.#..#...#
#...#..###
##.#######

Tile 1283:
....####.#
....##...#
#....#...#
#..#..#...
.#...#...#
#.#....#..
......#...
#..#.#....
##...#....
#####...#.

Tile 1601:
###...#..#
#..#......
##.......#
.#..###...
.........#
.#.......#
..#......#
..........
.#...#...#
..###....#

Tile 2713:
.....#...#
#.#......#
###....#.#
...#.....#
#....#....
.#...#....
#.#....#..
.#..#...#.
##........
....##.###

Tile 1163:
#####.#.#.
##......##
.#.....#.#
#..##.#..#
#.##.#..##
#.##....##
.....#..##
.##.......
..#..#.#..
#.#..#....

Tile 3191:
#.######..
#..#.....#
#...#.#..#
#.##.#..#.
#.#.......
.#.......#
.........#
.......##.
#.#.......
####.#####

Tile 3299:
#.#.......
#........#
#.....####
.##....#.#
.#..#.....
..........
.....#.###
........##
.....####.
#....#.###

Tile 1571:
..#...#...
.....#..#.
..#.##.#.#
#.#.###..#
.........#
#.......#.
#.#...##.#
.#.......#
..#......#
#..##....#

Tile 2903:
##.##..##.
.........#
..#......#
..#......#
.....#.#..
#..#.#...#
....##...#
.#.....#..
.....#.#..
##..#.#.#.

Tile 2843:
....#.##.#
#.........
#..##.....
....#....#
.#....#..#
...##...#.
.....#.###
.....#...#
.#.....#..
..###...#.

Tile 1873:
..#.####..
#.....##..
#........#
#.........
##....#...
.....#...#
#........#
#.....##..
..#..#....
#..###....

Tile 2207:
##.#..##..
....#.....
.#..#.....
##.......#
##.##..#..
....###..#
#....#....
#.#.#.....
..#.##....
#.##.#.##.

Tile 1973:
#...##.#.#
...##...##
......#...
..#.#.....
..#.......
###...#.#.
.#.#......
#......#.#
.....#.###
..######.#

Tile 1511:
.#..#.....
.....#...#
........##
..#.#....#
#...#.....
#...##...#
#..#......
#....#...#
#...#....#
..#.#...#.

Tile 3449:
##........
...#.....#
#.........
..##....##
.#.##..#..
#..##....#
#.........
#......#.#
##....#..#
###..##..#

Tile 1607:
#.###.####
.##.##....
......#..#
...#......
.#.....#.#
......#.##
.....#..#.
##.#.#...#
#..#..#..#
#.##..#...

Tile 1777:
###..#...#
.##......#
#..#.#...#
....#..#..
.#........
#..#..#...
......#.##
##.##.#..#
###.#.#...
#.###..#..

Tile 1097:
#.####.#..
#....##...
...##.##..
#......##.
#..#...#.#
..###.#...
#....#...#
#.##..#.##
#...#.#...
.#.##....#

Tile 3877:
..#######.
#.........
#......#.#
#........#
#...#.....
#......#..
.##.....#.
..........
##....#..#
.....##..#

Tile 1451:
....#...##
#.....#..#
.#..#..#.#
...#......
...#.#...#
##..#.#..#
##.....#..
..#.....##
##..#.#..#
#.##.#..#.

Tile 2411:
.....#####
..#......#
#.#......#
..#.##...#
###....#.#
...#.....#
#.#......#
....##....
......#...
####...#.#

Tile 2243:
##.###..##
.......#..
#.....#...
.......#.#
......#.#.
...#.#..#.
.........#
#.....##..
#....#...#
#..#.....#

Tile 3637:
..##.#..##
..........
..#...#.#.
#...#....#
#.....##..
#....#..##
####.#...#
#.#....#..
..#.#.....
.##.#####.

Tile 1213:
####..###.
#........#
#.......#.
#......#..
...#.....#
#....#....
..........
.......#..
#.#.....#.
......##..

Tile 1901:
#....#..##
#.......#.
....#....#
.........#
..#.......
#.###....#
.....###.#
....#.##.#
.........#
#######.##

Tile 3469:
.##.#.#..#
#..##...##
#.#..##...
.#..#....#
.....#...#
#....#....
#....#....
##......##
#......#..
#.#..#...#

Tile 3371:
..#.......
......#..#
..........
#..#...#.#
#........#
#.....##.#
.#.....#.#
..........
..........
.#.###.###

Tile 1013:
..##..##.#
.........#
..........
..........
...#......
#..#.#....
##...#...#
##..#...##
#..#.....#
###.#..#..

Tile 3011:
######..##
..#......#
.##......#
#.#...###.
#.#..#....
#......#.#
#..#..#..#
#...#.....
.........#
##.#.###.#

Tile 1009:
##...#####
........##
.........#
##.#.###.#
##..#.##.#
.####...##
##........
#.........
......##..
##.###..##

Tile 2659:
.#....#...
#..#...#..
#.#..#..#.
.#....#...
.........#
#.......#.
##.###.#..
#...#....#
#......#..
..#..#.##.

Tile 1301:
.##...##..
....#..#.#
#..#......
...#.....#
###.#.#...
##.....#..
#...#....#
.#..#.#..#
#..#......
#.#...##.#

Tile 1847:
..####..##
#.........
#.#..##...
##...##...
##..#...##
........#.
#.##......
...#..#...
##..##.#..
##.##..##.

Tile 2203:
#.##.##.##
.#.#..##.#
###.##..#.
#...#....#
#.#....#..
....#..###
####.#.###
##.##..###
#...#...##
.#...###..

Tile 2089:
..####.###
#.#.##..#.
#....#..##
#.........
..#......#
#...#.....
.....#..#.
#........#
#.#......#
..#.......

Tile 1613:
###.#..###
#....#...#
..#...#..#
#........#
#.......##
#........#
.........#
#........#
..#......#
#...####..

Tile 1297:
#.##....##
....##.#.#
......#..#
#...#....#
#........#
...#..#..#
.#..#..#..
...#...#.#
......#..#
#.##....#.

Tile 2939:
##...####.
.##......#
..#.#....#
.........#
##....##..
.......#..
##..#.....
.##..#..#.
#.......#.
..##.#####

Tile 1187:
####.#..#.
#..##.#..#
.#.#.....#
#.........
#.#.....##
#.....#..#
#........#
#..#......
..........
##.#..##.#

Tile 2671:
#..##.###.
.........#
....#....#
...###....
......#...
##.#.#....
.........#
...#.#...#
#.........
##.##.....

Tile 1181:
..##.###..
..##......
....#..#.#
#...#....#
.....##...
#.##.#....
#........#
.....#....
#..#......
..###....#

Tile 2591:
##........
#.#..##...
........#.
.........#
#....##...
#.#..#..##
..##......
.........#
....#..##.
.#####..#.

Tile 2029:
.#.#.##...
#...#..##.
..........
.......#.#
#..#.#.#.#
#..#.....#
#......#..
.##.......
##.......#
##...##.#.

Tile 2377:
..#..#.#.#
....#...#.
..#...#..#
##........
#...#....#
#..##.....
#.##.....#
.#..#...#.
##......#.
....#...##

Tile 1399:
########.#
#......#..
.........#
.......#.#
#...#....#
#.....#...
.........#
.#.....#..
.#........
#..###.###

Tile 3343:
#.##..####
.#.###....
....#..#..
#........#
#..#......
.........#
#........#
###.......
.#...#....
..###.#.#.

Tile 3923:
..#.#.####
.......#.#
#.#.#....#
..........
..........
.#........
#.####..##
##.##..#..
#......#.#
.##..#.#..

Tile 2837:
...##..#.#
#..#.....#
...#......
#.#..#...#
.....#....
##......##
..#...#..#
...##...#.
#..##.....
#.##.#.#..

Tile 1811:
.#.###.#..
#.#......#
##.......#
..........
........#.
..#..##.#.
....#....#
#........#
.........#
#.##..##..

Tile 3221:
..####..##
....##....
.#.##.#...
...#.....#
......##.#
...#...#..
..........
#.......##
#.#.......
.#.#.....#

Tile 3079:
...##.####
.......###
##....#...
#........#
........#.
#...#...#.
..#.....#.
#....#....
.#.....#.#
..###.####

Tile 2749:
.#####....
##...#...#
#..#..#..#
..........
.#......##
.#.......#
......#..#
...#.....#
......#...
######.##.

Tile 2039:
......##..
.#........
#.......##
....#.#..#
#..#.....#
.#....#..#
..........
#....#...#
......##.#
#..###.#.#

Tile 2287:
.######...
#..##...#.
#..#..#...
..#.#..#.#
####.....#
........##
....#..#.#
#..#..#...
##.#.....#
#...##.#..

Tile 3533:
#..##.#.##
.#.#....#.
....#.....
.........#
.#........
.#...#...#
...#.##..#
#.....####
#......#..
.##...#.#.

Tile 1609:
###.....#.
..#..#...#
..#.#....#
.#.......#
#..#.....#
......##..
.........#
#....##..#
..........
###.##.#.#

Tile 3001:
##...###..
.#.##.....
##...#....
..#.....##
...#.....#
...#...#.#
.......#..
.#.##...#.
....#.#..#
...#......

Tile 1951:
#.###..#.#
##........
...#.....#
.....##..#
....#.#...
..#......#
..........
##..#.#..#
#....#.#..
######...#

Tile 2371:
.#...#....
...##.#.##
##.......#
.#....##.#
....#....#
#..#..#...
#...#...#.
....##..#.
#...#...#.
#....#.#..

Tile 1171:
....#...#.
..##......
##....#...
#..#.....#
#.......#.
..##......
......#...
###....#.#
...#..##.#
.#.##.#...

Tile 2621:
##...#..##
#....##..#
..........
#.....#.##
..........
#........#
##..#..#..
#.####..##
....#.####
#....##...

Tile 1619:
#...#.###.
#.......##
#.........
#.#......#
#........#
#.#.....#.
#........#
#......#.#
..######.#
#.#.#.###.

Tile 1493:
##..##..#.
....###...
#.......#.
#...#....#
##...#...#
#.##....#.
...#......
.....#.###
..........
..#.#..##.

Tile 2879:
..##..#...
.......#..
....#...#.
#..#.....#
....#.#.#.
.#..#...##
#.......##
#.........
#.......#.
.#.#..#..#

Tile 3217:
##.###...#
.#.......#
...##..##.
...#....#.
..##.#....
...##.....
#..#......
#...#.....
#.....#...
#..##..#.#

Tile 2161:
..#.#.#.#.
..#..#...#
#..#......
....#.....
#......#.#
#........#
.........#
.......#.#
..........
.######.##

Tile 2293:
#..##...#.
.......#.#
........##
#......#.#
#......#..
#.........
.....#....
.#..#.#...
....#..#..
#.#.##..##

Tile 1871:
#.#..#..#.
..........
.......#..
#...#.....
###.#.....
.........#
....#....#
..#.......
#.........
#####.#..#

Tile 2393:
.#....##.#
#........#
#..#......
#..#......
..#.......
#.#..#..#.
#.##....##
#.#.......
#.#......#
.#...#.###

Tile 3461:
#.#...#...
.........#
#.....#..#
..#......#
#.......##
.....#..#.
##...#...#
#.........
#.........
#.#####.##

Tile 1543:
#...#.#.#.
.#........
#........#
#....#....
.##.......
#.....##..
#.#.###...
.....#.#.#
#....#....
#....#...#

Tile 1201:
##.....##.
..##.....#
#......#.#
..##...#.#
###.......
##..#....#
#..#.#...#
...#.....#
#...#.#...
.#.#...#..

Tile 3607:
...###...#
##......##
..........
#.#...#...
##......##
#.....##.#
#.........
.....#..#.
.#.....##.
##....####

Tile 3727:
#...#.#...
.##...####
......###.
.........#
.........#
#.##.#....
.......#.#
###.##.#.#
#....##..#
##.##.###.

Tile 3391:
#.###.#...
..#.....##
####....##
#...#.##..
.#......##
.#....#...
#...#....#
..#..#..#.
#.......##
#.##..#..#

Tile 3719:
#.#..#.#.#
.#.......#
#.#....#.#
........#.
..#......#
#..##.....
#.....#...
#.###.#.##
..........
..#..#....

Tile 1889:
....#.##..
#.......#.
.......#..
##.....#..
...#.....#
........##
.......#.#
#.#...##..
#.......#.
..#.#...#.

Tile 2789:
..#.###..#
..##.....#
#.........
..........
#...#..#.#
#..#....##
.##.......
#...#.....
..#....##.
####....#.

Tile 3761:
#.#..##.#.
#.........
#..##.....
##.#.....#
#..#.....#
....#..##.
#.......#.
#...#...##
..#..#...#
......#.##

Tile 2477:
..#......#
##.......#
#.........
#.#......#
#.#.##...#
..##.....#
#.#......#
.#........
#.........
.#.##..##.

Tile 3919:
.####.#..#
#.#.#....#
#......#.#
#.##.....#
##........
..........
#..#.....#
#....#...#
#.#.....##
..####.##.

Tile 2269:
#.....##.#
.........#
.........#
....###...
...#.#....
.#....#..#
#.....#..#
..#..#...#
......#...
###.#.#.#.

Tile 1091:
#..#.#.##.
#..##...##
.#.......#
#......#..
#......#..
......#.##
#..#....#.
#.......#.
......#...
..#.#...##

Tile 2917:
..##.#.###
#.........
.#.......#
#.....#...
....#..###
.....#.#.#
..........
#.....#...
#.......#.
##....#...

Tile 3947:
.#.......#
#.........
#....#..#.
#.####....
.....#....
......#..#
#........#
...#.#....
#.##....#.
.#.###..#.

Tile 2719:
####.###.#
..#.#.....
...#...#..
#....#..#.
#.....##.#
#..##.....
...##...##
#...##....
....#...#.
##.#...#..

Tile 1321:
.#.##..#.#
#.....#..#
..........
.#.#......
.........#
#.#.#..#.#
#...#.....
.#.##....#
.##.......
..#####.##

Tile 3167:
..#.####.#
#.#.......
...#.....#
#.##...#.#
.......##.
....#...#.
...#...#.#
..#..#...#
...#...###
#.##......

Tile 3041:
#..#...###
#.......##
#.........
.#......##
...#...#.#
.#........
##..#....#
.#.#......
.#.....#.#
..#...#.#.

Tile 1279:
..###..#.#
###...###.
###.....#.
.#........
##.....#..
###.#..#.#
##.#.....#
#.....#.##
.##..#..#.
###.####.#

Tile 1249:
..#..#..##
#...#.....
#.#......#
..........
#.......##
#.......#.
.........#
.........#
#...##.#.#
#..#..##.#

Tile 2791:
#.#.##.##.
..#.....#.
##...###..
......##..
........##
#...#..#..
.......#..
#.........
.#....##..
.##.###..#

Tile 3257:
.##.####.#
#..#.#...#
#........#
...#...#.#
#..#...###
..#..#..#.
.........#
#..#..##.#
...#.....#
..##..#.##

Tile 3677:
.####..###
#........#
.....#....
#.#......#
..#.....#.
.........#
#........#
.....#.#..
..#.#..##.
#.##....##

Tile 3329:
.####.....
##......##
#...#...##
###....#..
.##..#..#.
.#......##
..#....#.#
##..#...#.
...#...##.
#.####.###

Tile 1103:
.###.##...
##..#...##
#..#.#...#
...#.#..#.
#....#..#.
..........
#.........
...#.....#
#..##....#
.#....#..#

Tile 3917:
#.#.#..###
#......#.#
.#........
##...#....
.##.#..#..
#.......##
..........
..##......
.........#
.##.##..##

Tile 3571:
...#......
......#.#.
...#...#.#
.......#..
..........
.....#...#
#.........
#.........
..#.......
#.......##

Tile 3389:
###.#..###
......#...
.##.......
#.........
...##.....
.....#..#.
#..#.#...#
#.........
....#.....
.##.###...

Tile 2267:
#..#.#.###
........##
#.....##..
#..####...
.........#
#.#....#.#
#........#
#.....##..
#........#
#..#....#.

Tile 2099:
.#.###...#
#.........
.......#.#
...##.....
##...#....
##.......#
##..##..#.
##.....##.
#........#
##...##..#

Tile 3169:
..#.#.#..#
#..#.....#
##.......#
##........
..........
.........#
...#.##..#
#.........
#...#....#
.#.......#

Tile 1049:
#.#.###.#.
.#.......#
..#.#.#...
#.#...#..#
#......#.#
#...#....#
#........#
#..#.....#
##........
#.#.#..#.#

Tile 3023:
##..#..#..
..#......#
....#..#.#
.....#...#
..........
.........#
#..#.#....
#.....#...
..#......#
..##.##.##

Tile 2153:
#.#......#
......#.#.
#.....#...
#.......#.
#..##.....
.#......#.
........##
.....##..#
#...#.##..
..#####..#

Tile 2909:
##..#.###.
#......#..
.#...#....
#.......#.
#.....#.##
.#........
....#..#.#
##..#.#...
..##.....#
##.##...##

Tile 3457:
####..##.#
##.#.#....
###....##.
#..#.##.#.
.......#..
...#..#..#
#........#
.......#..
.#...##..#
#.#.#.###.

Tile 3019:
.##..###.#
......#...
#..#.....#
#..#......
#.#.......
###......#
#.#....#..
..........
.........#
#....##.##"""

def rotate(tile):
    """
    #..
    ..#
    ###
    ->
    #.#
    #..
    ##.
    """
    rotated_tile = [['.' for c in range(len(tile[0]))] for r in range(len(tile))]

    for i, row in enumerate(tile):
        rotated_tile[0][i] = tile[len(tile)-1-i][0]
        rotated_tile[-1][len(tile)-1-i] = row[-1]

    for i, cell in enumerate(tile[0]):
        rotated_tile[i][-1] = cell

    for i, cell in enumerate(tile[-1]):
        rotated_tile[i][0] = cell

    return tuple("".join(row) for row in rotated_tile)


def all_rotations_of_tile(tile):
    rotations = [tile]
    rotations.append(rotate(rotations[-1]))
    rotations.append(rotate(rotations[-1]))
    rotations.append(rotate(rotations[-1]))
    return rotations


def flip(tile):
    flipped_tiles = [tile]

    # flip horizontally
    flipped_tiles.append(tuple(reversed(tile)))

    # flip vertically
    flipped_vert = []
    for row in tile:
        flipped_vert.append("".join(list(reversed(row))))

    flipped_tiles.append(tuple(flipped_vert))
    return flipped_tiles

def solve(tile_defs):
    curr_tile = ""

    tiles = {}

    for line in tile_defs.split("\n"):
        if not line:
            continue
        if line.startswith("Tile "):
            curr_tile = line.split(" ")[1][:-1]
            tiles[int(curr_tile)] = []
        else:
            tiles[int(curr_tile)].append(line)

    # hollow out the tiles for visual debugging: we only care about matching the edges of the tiles
    for tile_id in tiles:
        tile_rows = tiles[tile_id]
        hollowed_rows = []
        for i, row in enumerate(tile_rows):
            if i == 0 or i == len(tile_rows) - 1:
                hollowed_rows.append(row)
            else:
                hollowed_rows.append(row[0] + '.'*8 + row[-1])
        tiles[tile_id] = tuple(hollowed_rows)

    board_dimension = int(len(tiles)**0.5)

    board = tuple(tuple(None for c in range(board_dimension)) for r in range(board_dimension))
    print(f"{board=}")

    print(f"there are {len(tiles)} in the grid")

    first_coord = Coord(x=0, y=0)
    answer = _place_tiles(board, tiles, first_coord, seen=set())
    tl = answer[0][0]
    tr = answer[0][-1]
    bl = answer[-1][0]
    br = answer[-1][-1]

    return tl.tile_id * tr.tile_id * bl.tile_id * br.tile_id


def matches_left(board, coord, candidate):
    if coord.x == 0:
        return True
    left_neighbour = board[coord.y][coord.x-1].tile

    # print("does", candidate, "match", left_neighbour, "to the left")

    for match_row, row in zip(left_neighbour, candidate):
        if match_row[-1] != row[0]:
            return False

    return True


def matches_up(board, coord, candidate):
    if coord.y == 0:
        return True

    up_neighbour = board[coord.y-1][coord.x].tile

    return candidate[0] == up_neighbour[-1]


def pretty_print(board):
    # for tile_row in board:
    #     tile1, tile2, tile3 = [t.tile if t else None for t in tile_row]
    #     if tile1 is None:
    #         tile1 = " " * 10
    #     if tile2 is None:
    #         tile2 = " " * 10
    #     if tile3 is None:
    #         tile3 = " " * 10
    #     for i in range(len(tile1)):
    #         print(tile1[i], tile2[i], tile3[i])
    #     print("")

    for tile_row in board:
        print(" ".join(map(str, [t.tile_id if t else None for t in tile_row])))
        print("")


def _place_tiles(board, tiles, coord, seen):
    if len(seen) % 1000 == 0:
        print(f"cache includes {len(seen)} states")

    if (board, coord, tuple(tiles.items())) in seen:
        return None

    seen.add((board, coord, tuple(tiles.items())))

    if coord.y == len(board):
        assert coord.x == 0
        pretty_print(board)
        return board

    for tile_id, tile in tiles.items():
        # try placing any rotation or flip of `tile` at `coord`, then move next
        tile_options = []
        for rotated_tile in all_rotations_of_tile(tile):
            for flipped_rotation in flip(rotated_tile):
                tile_options.append(flipped_rotation)

        for candidate in tile_options:
            if not matches_left(board, coord, candidate):
                continue

            if not matches_up(board, coord, candidate):
                continue

            board_copy = [[t for t in row] for row in board]
            assert board_copy[coord.y][coord.x] is None

            board_copy[coord.y][coord.x] = Tile(tile_id=tile_id, tile=candidate)
            board_copy = tuple(tuple(r) for r in board_copy)

            if coord.x == len(board[0]) - 1:
                next_coord = Coord(y=coord.y + 1, x=0)
            else:
                next_coord = Coord(y=coord.y, x=coord.x + 1)

            tiles_without_this_tile = dict(tiles)
            del tiles_without_this_tile[tile_id]

            answer = _place_tiles(board_copy, tiles_without_this_tile, next_coord, seen)
            if answer:
                return answer

    return None

def test_rotate():

    tile = (
        "#....####.",
        "#.........",
        "#.........",
        "#........#",
        ".........#",
        ".........#",
        "..........",
        "#........#",
        "#.........",
        "..###.#.#.",
        )

    rotated_once = (
        ".##...####",
        "..........",
        "#.........",
        "#.........",
        "#.........",
        ".........#",
        "#........#",
        ".........#",
        "#........#",
        "..#.###...",
        )
    assert rotate(tile) == rotated_once

    rotated_twice = (
        ".#.#.###..",
        ".........#",
        "#........#",
        "..........",
        "#.........",
        "#.........",
        "#........#",
        ".........#",
        ".........#",
        ".####....#",
        )

    assert rotate(rotated_once) == rotated_twice

    rotated_thrice = (
        "...###.#..",
        "#........#",
        "#.........",
        "#........#",
        "#.........",
        ".........#",
        ".........#",
        ".........#",
        "..........",
        "####...##.",
        )

    assert rotate(rotated_twice) == rotated_thrice

    assert rotate(rotated_thrice) == tile

    """
    start with this tile, then test rotating 4 times
    #..
    ..#
    #.#
    """

    """
    #.#
    ...
    ##.
    """
    tile = ("#..", "..#", "#.#")
    rotated_once = rotate(tile)
    assert rotated_once == ("#.#", "...", "##.")

    """
    #.#
    #..
    ..#
    """
    rotated_twice = rotate(rotated_once)
    assert rotated_twice == ("#.#", "#..", "..#")

    """
    .##
    ...
    #.#
    """
    rotated_thrice = rotate(rotated_twice)
    assert rotated_thrice == (".##", "...", "#.#")

    assert rotate(rotated_thrice) == tile

if __name__ == "__main__":
    test_rotate()
    assert(solve(TEST_INPUT) == 20899048083289)
    print(solve(PUZZLE_INPUT))
